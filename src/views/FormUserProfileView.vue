<template>
    <div class="profile-page">
        <section class="profile-hero">
            <h1>{{ heroTitle }}</h1>
            <p>{{ heroSubtitle }}</p>
        </section>

        <section class="profile-card">
            <transition name="fade">
                <p v-if="loadError" class="feedback feedback--error" role="alert">
                    {{ loadError }}
                </p>
            </transition>

            <form class="profile-form" @submit.prevent="submitProfile">
                <div v-if="isLoading" class="profile-loading">
                    <span class="profile-loading__text">{{ loadingLabel }}</span>
                </div>

                <div v-else class="profile-layout">
                    <UserAvatarUpload :label="photoLabel" :hint="photoHint" :upload-label="uploadLabel"
                        :remove-label="removeLabel" :initials="avatarInitial" :disabled="isSubmitting"
                        @busy-change="handleAvatarBusyChange" @error="handleAvatarError"
                        @clear-feedback="handleAvatarFeedbackClear" @avatar-updated="handleAvatarUpdated" />

                    <div class="profile-fields">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="profile_display_name">{{ t('user_profile_display_name') }}</label>
                                <input id="profile_display_name" v-model="profile.displayName" type="text"
                                    autocomplete="nickname" :disabled="isSubmitting" required />
                            </div>
                            <div class="form-group">
                                <label for="profile_first_name">{{ t('user_profile_first_name') }}</label>
                                <input id="profile_first_name" v-model="profile.firstName" type="text"
                                    autocomplete="given-name" :disabled="isSubmitting" />
                            </div>
                            <div class="form-group">
                                <label for="profile_last_name">{{ t('user_profile_last_name') }}</label>
                                <input id="profile_last_name" v-model="profile.lastName" type="text"
                                    autocomplete="family-name" :disabled="isSubmitting" />
                            </div>
                            <div class="form-group">
                                <label for="profile_email">{{ t('user_profile_email') }}</label>
                                <input id="profile_email" v-model="profile.emailAddress" type="email"
                                    autocomplete="email" :disabled="isSubmitting" required />
                            </div>
                        </div>

                        <div class="profile-preferences">
                            <div class="profile-preferences__header">
                                <h4>{{ preferencesHeading }}</h4>
                                <p>{{ preferencesDescription }}</p>
                            </div>
                            <div class="profile-preferences__grid">
                                <div class="form-group">
                                    <label for="profile_language">{{ t('language') }}</label>
                                    <select id="profile_language" v-model="selectedLocale" :disabled="isSubmitting">
                                        <option v-for="option in localeOptions" :key="option.value"
                                            :value="option.value">
                                            {{ option.label }}
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="profile_theme">{{ t('settings_theme') }}</label>
                                    <select id="profile_theme" v-model="selectedTheme" :disabled="isSubmitting">
                                        <option v-for="option in themeOptions" :key="option.value"
                                            :value="option.value">
                                            {{ t(option.label) }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    <transition name="fade">
                        <p v-if="submitError" class="feedback feedback--error" role="alert">
                            {{ submitError }}
                        </p>
                    </transition>
                    <transition name="fade">
                        <p v-if="submitSuccess" class="feedback feedback--success" role="status">
                            {{ submitSuccess }}
                        </p>
                    </transition>

                    <button type="submit" :disabled="saveDisabled">
                        <span v-if="!isSubmitting">{{ saveButtonLabel }}</span>
                        <span v-else>{{ savingLabel }}</span>
                    </button>
                </div>
            </form>
        </section>
    </div>
</template>

<script setup lang="ts">
import { computed, onMounted, reactive, ref } from 'vue'
import { useI18n } from 'vue-i18n'
import { useThemeStore } from '@/store/themeStore'
import { useUserStore } from '@/store/userStore'
import UserAvatarUpload from '@/components/UserAvatarUpload.vue'
import type { ThemeMode } from '@/utils/theme'
import { apiFetch } from '@/api'

interface UserProfilePayload {
    user_id?: string | number | null
    display_name?: string | null
    email_address?: string | null
    first_name?: string | null
    last_name?: string | null
    locale?: string | null
    theme?: ThemeMode | null
}

const { t, te, locale } = useI18n({ useScope: 'global' })
const themeStore = useThemeStore()
const userStore = useUserStore()

const isThemeMode = (value: unknown): value is ThemeMode => value === 'light' || value === 'dark'

const profile = reactive({
    displayName: '',
    emailAddress: '',
    firstName: '',
    lastName: '',
})

const isLoading = ref(true)
const isSubmitting = ref(false)
const isAvatarBusy = ref(false)
const loadError = ref<string | null>(null)
const submitError = ref<string | null>(null)
const submitSuccess = ref<string | null>(null)

const localeOptions: Array<{ value: string; label: string }> = [
    { value: 'en', label: 'English' },
    { value: 'da', label: 'Dansk' },
    { value: 'de', label: 'Deutsch' },
]

const themeOptions: Array<{ value: ThemeMode; label: string }> = [
    { value: 'light', label: 'settings_theme_light' },
    { value: 'dark', label: 'settings_theme_dark' },
]

const heroTitle = computed(() => (te('user_profile_title') ? t('user_profile_title') : 'Update your profile'))
const heroSubtitle = computed(() => (te('user_profile_subtitle') ? t('user_profile_subtitle') : 'Manage how others see your information.'))
const photoLabel = computed(() => (te('user_profile_photo_label') ? t('user_profile_photo_label') : 'Profile picture'))
const photoHint = computed(() => (te('user_profile_photo_hint') ? t('user_profile_photo_hint') : 'JPG or PNG, max 5 MB.'))
const uploadLabel = computed(() => (te('user_profile_upload') ? t('user_profile_upload') : 'Upload new photo'))
const removeLabel = computed(() => (te('user_profile_remove_photo') ? t('user_profile_remove_photo') : 'Remove photo'))
const saveButtonLabel = computed(() => (te('user_profile_save') ? t('user_profile_save') : 'Save profile'))
const successMessage = computed(() => (te('user_profile_save_success') ? t('user_profile_save_success') : 'Profile updated successfully.'))
const saveErrorMessage = computed(() => (te('user_profile_save_error') ? t('user_profile_save_error') : 'Could not save your profile.'))
const loadErrorMessage = computed(() => (te('user_profile_load_error') ? t('user_profile_load_error') : 'Could not load your profile.'))
const loadingLabel = computed(() => (te('user_profile_loading') ? t('user_profile_loading') : 'Loading profile…'))
const validationMessage = computed(() => (te('user_profile_validation_error') ? t('user_profile_validation_error') : 'Please provide a display name and email address.'))
const savingLabel = computed(() => (te('form_saving') ? t('form_saving') : 'Saving…'))
const preferencesHeading = computed(() => (te('user_profile_preferences_heading') ? t('user_profile_preferences_heading') : 'Workspace preferences'))
const preferencesDescription = computed(() => (te('user_profile_preferences_description') ? t('user_profile_preferences_description') : 'Choose your language and theme for the dashboard.'))
const selectedLocale = computed({
    get: () => locale.value,
    set: (value: string) => {
        locale.value = value
    },
})

const selectedTheme = computed({
    get: () => themeStore.theme,
    set: (value: ThemeMode) => themeStore.setTheme(value),
})

const avatarInitial = computed(() => {
    const source = (profile.displayName || `${profile.firstName} ${profile.lastName}`).trim()
    if (!source) return '?'
    return source.charAt(0).toUpperCase()
})

const saveDisabled = computed(() => {
    if (isLoading.value || isSubmitting.value || isAvatarBusy.value) return true
    return !profile.displayName.trim() || !profile.emailAddress.trim()
})

const resolveProfileError = (err: unknown): string => {
    if (typeof err === 'object' && err && 'data' in err) {
        const apiErr = err as { data?: { error?: string } }
        if (apiErr.data?.error) {
            return apiErr.data.error
        }
    }

    if (err instanceof Error && err.message) {
        return err.message
    }

    return saveErrorMessage.value
}

const mapResponseToState = (payload: UserProfilePayload | null | undefined) => {
    if (!payload || typeof payload !== 'object') {
        return
    }

    if ('display_name' in payload) {
        profile.displayName = typeof payload.display_name === 'string' ? payload.display_name : ''
    }

    if ('email_address' in payload) {
        profile.emailAddress = typeof payload.email_address === 'string' ? payload.email_address : ''
    }

    if ('first_name' in payload) {
        profile.firstName = typeof payload.first_name === 'string' ? payload.first_name : ''
    }

    if ('last_name' in payload) {
        profile.lastName = typeof payload.last_name === 'string' ? payload.last_name : ''
    }

    const userIdValue = payload.user_id
    if ((typeof userIdValue === 'string' || typeof userIdValue === 'number') && userIdValue !== '') {
        userStore.setUserId(String(userIdValue))
    }

    if (typeof payload.display_name === 'string') {
        userStore.setDisplayName(payload.display_name)
    }

    if (typeof payload.locale === 'string' && payload.locale.trim()) {
        locale.value = payload.locale
    }

    if (typeof payload.theme === 'string' && isThemeMode(payload.theme)) {
        themeStore.setTheme(payload.theme)
    }
}

const loadProfile = async () => {
    isLoading.value = true
    loadError.value = null

    try {
        const { data } = await apiFetch<UserProfilePayload>('/api/admin/user/me')
        mapResponseToState(data)
    } catch (err: unknown) {
        if (err instanceof Error && err.message) {
            loadError.value = err.message
        } else {
            loadError.value = loadErrorMessage.value
        }
    } finally {
        isLoading.value = false
    }
}

const submitProfile = async () => {
    submitError.value = null
    submitSuccess.value = null

    if (!profile.displayName.trim() || !profile.emailAddress.trim()) {
        submitError.value = validationMessage.value
        return
    }

    if (isAvatarBusy.value) {
        return
    }

    isSubmitting.value = true

    const trimmedEmail = profile.emailAddress.trim()

    const payload = {
        display_name: profile.displayName.trim(),
        email_address: trimmedEmail,
        first_name: profile.firstName.trim() || null,
        last_name: profile.lastName.trim() || null,
        locale: selectedLocale.value,
        theme: selectedTheme.value,
    }

    try {
        const { data } = await apiFetch<UserProfilePayload>('/api/admin/user/me', {
            method: 'PUT',
            body: JSON.stringify(payload),
        })

        mapResponseToState(data)
        userStore.setDisplayName(payload.display_name)
        submitSuccess.value = successMessage.value
    } catch (err: unknown) {
        submitError.value = resolveProfileError(err)
    } finally {
        isSubmitting.value = false
    }
}

onMounted(() => {
    void loadProfile()
})

const handleAvatarBusyChange = (value: boolean) => {
    isAvatarBusy.value = value
}

const handleAvatarError = (message: string | null) => {
    if (message) {
        submitError.value = message
        submitSuccess.value = null
    }
}

const handleAvatarFeedbackClear = () => {
    submitError.value = null
    submitSuccess.value = null
}

const handleAvatarUpdated = () => {
    userStore.bumpAvatarVersion()
}
</script>

<style scoped lang="scss">
.profile-page {
    @include form-page();
}

.profile-hero {
    @include form-hero(520px);
}

.profile-card {
    @include form-card(920px, clamp(1.75rem, 4vw, 2.5rem), clamp(1.25rem, 3vw, 1.75rem));
    position: relative;
}

.profile-form {
    display: flex;
    flex-direction: column;
    gap: clamp(1.5rem, 3vw, 2rem);
}

.profile-loading {
    min-height: 240px;
    border-radius: 18px;
    background: var(--input-bg);
    display: grid;
    place-items: center;
    color: var(--muted-text);
    font-weight: 600;
}

.profile-loading__text {
    text-align: center;
}

.profile-layout {
    display: grid;
    gap: clamp(1.5rem, 3vw, 2rem);
    grid-template-columns: minmax(260px, 0.9fr) minmax(0, 1.1fr);
    align-items: start;
}

.profile-fields {
    display: flex;
    flex-direction: column;
    gap: clamp(1.25rem, 3vw, 1.75rem);
}

.profile-preferences {
    display: flex;
    flex-direction: column;
    gap: clamp(0.75rem, 2vw, 1.1rem);
    padding: clamp(1rem, 3vw, 1.5rem);
    border-radius: 18px;
    border: 1px solid var(--border-soft);
    background: var(--input-bg);
}

.profile-preferences__header {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.profile-preferences__header h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
}

.profile-preferences__header p {
    margin: 0;
    color: var(--muted-text);
    font-size: 0.9rem;
    line-height: 1.5;
}

.profile-preferences__grid {
    @include form-grid(220px, clamp(0.9rem, 2vw, 1.2rem));
}

.form-grid {
    @include form-grid(220px, clamp(1rem, 2vw, 1.25rem));
}

.form-group {
    @include form-group();
}

.profile-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: flex-end;
}

.profile-actions button {
    @include form-primary-button($padding-y: 0.85rem, $padding-x: 2.2rem);
}

.feedback {
    @include form-feedback($text-align: right);

    &.feedback--error {
        @include form-feedback-error();
    }

    &.feedback--success {
        @include form-feedback-success();
    }
}

.fade-enter-active,
.fade-leave-active {
    transition: opacity 0.25s ease;
}

.fade-enter-from,
.fade-leave-to {
    opacity: 0;
}

@media (max-width: 900px) {
    .profile-layout {
        grid-template-columns: 1fr;
    }

    .profile-photo-wrapper {
        margin-inline: auto;
    }

    .profile-actions {
        align-items: stretch;
    }
}

@media (max-width: 540px) {
    .profile-card {
        padding: clamp(1.25rem, 6vw, 1.8rem);
    }

    .profile-photo-panel {
        align-items: center;
    }

    .profile-photo-panel__label {
        align-self: flex-start;
    }

    .profile-photo-hint {
        text-align: center;
    }

    .profile-actions button {
        width: 100%;
    }
}
</style>
